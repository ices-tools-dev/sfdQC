---
title: "ICES VMS datacall quality check report for `params$country`"
date: "`r format(Sys.time(), '%d %B, %Y')`"
header-includes:
  - \usepackage{comment}
  - \usepackage{booktabs}
  - \usepackage{longtable}
output: pdf_document
params:
    LE_filename: "data/LE.csv"
    VE_filename: "data/VE.csv"
    country: "test"
    eurPols: "begin/initial/eurPols.Rdata"
    utilities: "utilities.R"
---

<!-- QCTEMPLATE: header -->
```{r setup, eval=TRUE, echo=FALSE, cache=FALSE}
library(knitr)
library(kableExtra)

opts_chunk$set(comment   = NA,
               warning   = FALSE,
               message   = FALSE,
               error     = FALSE,
               echo      = FALSE,
               eval      = TRUE,
               dev = "my_png",
               fig.ext = "png",
               fig.align = 'left',
               tab.align = 'left',
               fig.width = 5.5)

options(knitr.kable.NA = '-')
options(knitr.table.format = 'latex')
options(digits = 4)

my_png <- function(file, width, height) {
  png(file, width = width, height = height, 
      res = 800, units = "in", pointsize = 20)
}

library(plyr)
library(ggplot2)
library(vmstools)
library(RColorBrewer)
library(doBy)
library(reshape2)

library(maps)
```

```{r load-data}
load(params$eurPols)
polLand <- fortify(eurPols)
```


```{r}
# helper functions

# Functions made pipe-able
CSquare2LonLat2 <- function(d, degrees) {
  
  dplyr::bind_cols(d,
                   vmstools::CSquare2LonLat(d$c_square, degrees = degrees)) %>% 
    #dplyr::rename(lon = SI_LONG, lat = SI_LATI) %>% 
    tibble::as_tibble()
  
}
ICESrectangle2LonLat2 <- function(d, midpoint) {
  
  dplyr::bind_cols(d,
                   vmstools::ICESrectangle2LonLat(d$ICES_rectangle, midpoint = midpoint)) %>% 
    #dplyr::rename(lon = SI_LONG, lat = SI_LATI) %>% 
    tibble::as_tibble()
    
}

q25 <- function(x) quantile(x, 0.25)
q75 <- function(x) quantile(x, 0.75)

grade <- function(x, dx) {
  brks <- seq(floor(min(x)), ceiling(max(x)),dx)
  ints <- findInterval(x, brks, all.inside = TRUE)
  x <- (brks[ints] + brks[ints + 1]) / 2
  return(x)
}
```


<!------------------------------------------------------------------------------
Data handling
---------------------------------------------------------------------------- -->
```{r data}
#Read in latest submission -->",
ICES_LE <- 
  readr::read_csv(params$LE_filename,
                  col_types = c('ccnncccnccnnn')) %>% 
  ICESrectangle2LonLat2(midpoint = TRUE)

ICES_VE <- 
  readr::read_csv(params$VE_filename,
                  # Note: last column here is "avg_gearWidth"
                  #       This was not specified in the first
                  col_types = c('ccnnccccnnnnnnnnn')) %>% 
  CSquare2LonLat2(degrees = 0.05)
```
<!------------------------------------------------------------------------------
Pre-calculations
---------------------------------------------------------------------------- -->


<!--------------------------
Checks for VMS data
------------------------ -->
```{r vms-checks}
#Most recent submission -->
country <- ICES_VE$country[1]
spatBound <- list(xrange = range(ICES_VE$SI_LONG, na.rm=TRUE),
                  yrange = range(ICES_VE$SI_LATI, na.rm=TRUE))
spatCore  <- list(xrange = quantile(ICES_VE$SI_LONG, c(0.025, 0.975)),
                  yrange = quantile(ICES_VE$SI_LATI, c(0.025, 0.975)))
tempBound <- range(ICES_VE$year, na.rm=TRUE)
```
<!--------------------------
Checks for logbook data
------------------------ -->
```{r logbook-checks}
#Most recent submission -->
spatBoundLog <- list(xrange = range(ICES_LE$SI_LONG, na.rm=TRUE),
                     yrange = range(ICES_LE$SI_LATI, na.rm=TRUE))
tempBoundLog <- range(ICES_LE$year, na.rm=TRUE)
```

<!--------------------------
Map background
------------------------ -->
```{r}
m.range <- 
  map_data("world", 
           xlim = spatBound$xrange,
           ylim = spatBound$xrange)
m.core <- 
  map_data("world",
           xlim = spatCore$xrange, 
           ylim = spatCore$yrange)
m.log <- 
  map_data("world",
           xlim = spatBoundLog$xrange, 
           ylim = spatBoundLog$yrange)
```

<!--------------------------
Utility stuff
------------------------ -->
```{r utilities}
source(params$utilities)
```


<!------------------------------------------------------------------------------
Tables & Figures VMS
---------------------------------------------------------------------------- -->

# Quality of the VMS data from `r country`

```{r check-for-vms, results='asis'}
hasvms <- nrow(ICES_VE) > 0
haslogbook <- nrow(ICES_LE) > 0
```

`r if (!hasvms) {"No VMS data available\n\\begin{comment}"}`

```{r set-eval-vms}
opts_chunk$set(eval = hasvms)
```

## Years & number of records for which data has been submitted:
```{r records-by-year, results='asis'}
d <- 
  ICES_VE %>% 
  dplyr::group_by(year) %>% 
  dplyr::count()

d %>% kable(booktabs = TRUE)

d %>% 
  ggplot(aes(x = year, y = n)) +
  theme_icesqc() +
  geom_col() +
  labs(x = "Year", y = "Number of records")
```

`r if (any(is.na(ICES_VE$SI_LONG))) {"\\newpage"}`

## Records assigned to invalid Statistical Rectangles
```{r invalid stat-sqrs}
if (any(is.na(ICES_VE$SI_LONG))) {
  kable(table(`ICES Rectangle` = ICES_VE$ICES_rectangle[is.na(ICES_VE$SI_LONG)],
              Year = ICES_VE$year[is.na(ICES_VE$SI_LONG)]), booktabs = TRUE)
} else {
  x <- "There were no invalid Statistical Rectangles reported"
  attr(x, "format") <- "markdown"
  attr(x, "class") <- "knit_asis"
  x
}
```


\newpage

## Distribution of pings by month:
```{r pings-by-month}
d <- 
  ICES_VE %>% 
  dplyr::group_by(year, month) %>% 
  dplyr::count()

d %>% 
  tidyr::spread(month, n) %>%
  kable(booktabs = TRUE)

d %>% 
  ggplot(aes(x = year, y = n, fill = factor(month))) +
  theme_icesqc() +
  geom_col() +
  scale_fill_grey(guide=guide_legend(title="Month")) +
  labs(x = "Year", y = "Number of records")
```

\newpage

## Spatial extent of data submitted by year:
```{r table-exent}
ICES_VE %>% 
  dplyr::select(year, long = SI_LONG, lat = SI_LATI) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise_all(dplyr::funs(min, max)) %>% 
  dplyr::select(year, dplyr::starts_with("long_"), dplyr::starts_with("lat_")) %>% 
  kable(booktabs = TRUE)
```

## Area for which data has been submitted:
```{r area-of-data,  fig.height = 9}
ICES_VE %>% 
  dplyr::select(year, long = SI_LONG, lat = SI_LATI) %>% 
  dplyr::mutate(long = grade(long, 0.5),
                lat = grade(lat, 0.5)) %>% 
  dplyr::distinct() %>% 
  ggplot(aes(long, lat)) +
  theme_void() +
  geom_polygon(data = m.range, aes(group = group), fill = "grey") +
  geom_raster(fill = "red") +
  coord_quickmap(xlim = spatBound$xrange, ylim = spatBound$yrange) +
  facet_wrap(~ year, ncol = 2) +
  labs(x = NULL, y = NULL)
```

```{r area-of-data2,  fig.height = 9}
ICES_VE %>% 
  dplyr::select(year, long = SI_LONG, lat = SI_LATI) %>% 
  dplyr::distinct() %>% 
  ggplot(aes(long, lat)) +
  theme_void() +
  geom_polygon(data = m.core, aes(group = group), fill = "grey") +
  geom_raster(fill = "red") +
  coord_quickmap(xlim = spatCore$xrange, ylim = spatCore$yrange) +
  facet_wrap(~ year, ncol = 2) +
  labs(x = NULL, y = NULL)
```

\newpage

## Frequency of vessel length categories by year:
```{r records-by-vessel-length}
d <- 
  ICES_VE %>% 
  dplyr::group_by(year, variable = vessel_length_category) %>% 
  dplyr::count()
d %>% 
  tidyr::spread(year, n) %>% 
  kable(booktabs = TRUE)

d %>% 
  ggplot(aes(year, n, fill = variable)) +
  theme_icesqc(legend.position = "right") +
  geom_col() +
  scale_fill_grey() +
  labs(x = "Year", y = "Number of records", fill = "Length category")
```

\newpage

## Frequency of gear codes by year:
```{r records-by-gear-code, results='asis'}
d <- 
  ICES_VE %>% 
  dplyr::group_by(year, variable = gear_code) %>% 
  dplyr::count()
d %>% 
  tidyr::spread(year, n) %>% 
  kable(booktabs = TRUE)

d %>% 
  ggplot(aes(year, n, fill = variable)) +
  theme_icesqc(legend.position = "right") +
  geom_col() +
  scale_fill_grey() +
  labs(x = "Year", y = "Number of records", fill = "Gear code")
```

\newpage

## Spatial extend of 3 most dominant gears:
```{r spatial-extent-dominant-gears, fig.height = 9}
topgear <- 
  ICES_VE %>% 
  dplyr::group_by(gear_code) %>% 
  dplyr::count() %>% 
  dplyr::arrange(desc(n)) %>% 
  dplyr::slice(1:3) %>%
  dplyr::pull(gear_code)
d <-
  ICES_VE %>% 
  dplyr::filter(gear_code %in% topgear) %>% 
  dplyr::group_by(year, long = SI_LONG, lat = SI_LATI, gear_code) %>% 
  dplyr::summarise(fishing_days = sum(fishing_hours, na.rm = TRUE)/24)

# legend calculations
steps <- ceiling(max(d$fishing_days, na.rm = TRUE)/250)
breaks <- unique(c(-1, 0, steps * c(1, 2.5, 5, 10, 25, 50, 100, 250)))
legval <- paste(breaks[-length(breaks)], "<=", breaks[-1L])
legval[1] <- "0"

palette <- c("white", RColorBrewer::brewer.pal(length(breaks)-2, "YlOrRd"))  
d$colgrp <- as.numeric(cut(d$fishing_days, breaks = breaks))
d$cols <- palette[d$colgrp]

for(i in 1:length(topgear)) {
  p <-
    d %>% 
    dplyr::filter(gear_code %in% topgear[i]) %>% 
    ggplot(aes(long, lat)) +
    theme_void() +
    geom_raster(aes(fill = cols)) +
    geom_polygon(data = m.core, aes(group = group), fill = "grey") +
    coord_quickmap(xlim = spatCore$xrange, ylim = spatCore$yrange) +
    scale_fill_manual(values = rev(palette), labels = rev(legval)) +
    guides(fill = guide_legend(title = paste("Days@Sea", topgear[i]))) +
    facet_wrap(~ year, ncol = 2) +
    theme(legend.position = "top")
  print(p)
}
```



## Number of unique DCF Level 6 codes by year:
```{r table-met6, results='asis'}
ICES_VE %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise(freq = dplyr::n_distinct(LE_MET_level6)) %>% 
  kable(booktabs = TRUE)
```

Top 5 DCF Level 6 codes by year:
```{r top5-met6}
top5Met6 <-
  ICES_VE %>% 
  dplyr::group_by(LE_MET_level6) %>% 
  dplyr::count() %>% 
  dplyr::arrange(desc(n)) %>% 
  dplyr::slice(1:5) %>% 
  dplyr::pull(LE_MET_level6)
d <-
  ICES_VE %>% 
  dplyr::filter(LE_MET_level6 %in% top5Met6) %>% 
  dplyr::group_by(year, LE_MET_level6) %>% 
  dplyr::count()
d %>% 
  tidyr::spread(year, n) %>% 
  kable(booktabs = TRUE)

d %>% 
  ggplot(aes(year, n, fill = LE_MET_level6)) +
  geom_col() +
  theme_icesqc(legend.position = "right") +
  scale_fill_grey() +
  labs(x = "Year", y = "Count", fill = "Level 6")
```

\newpage

## Average fishing speed:
```{r table-average-fishing-speed, results='asis'}
ICES_VE %>% 
  dplyr::select(year, avg_fishing_speed) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise_all(dplyr::funs(min, q25, median, mean, q75, max)) %>% 
  kable(booktabs = TRUE)
```

```{r average-fishing-speed}
ggplot(ICES_VE, aes(x = avg_fishing_speed)) +
  geom_histogram() +
  xlab("Average fishing speed") + ylab ("Count") +
  facet_wrap( ~ year, ncol = 2) +
  theme_icesqc()
```

\newpage

## Average fishing hours:
```{r table-fishing-hours, results='asis'}
ICES_VE %>% 
  dplyr::select(year, fishing_hours) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise_all(dplyr::funs(min, q25, median, mean, q75, max)) %>% 
  kable(booktabs = TRUE)
```

```{r fishing-hours}
ggplot(ICES_VE, aes(x = fishing_hours)) +
  geom_histogram() +
  xlab("Average fishing hours") + ylab("Count") +
  facet_wrap( ~ year, ncol = 2) +
  theme_icesqc()
```

\newpage

## Average length:
```{r table-length, results='asis'}
ICES_VE %>% 
  dplyr::select(year, avg_oal) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise_all(dplyr::funs(min, q25, median, mean, q75, max)) %>% 
  kable(booktabs = TRUE)
```
```{r length}
ggplot(ICES_VE, aes(x = avg_oal))+
  geom_histogram() +
  xlab("Average vessel length") + ylab("Count") +
  facet_wrap( ~ year, ncol = 2) +
  theme_icesqc()
```

\newpage

## Average kW:
```{r table-average-kW, results='asis'}
ICES_VE %>% 
  dplyr::select(year, avg_kw) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise_all(dplyr::funs(min, q25, median, mean, q75, max)) %>% 
  kable(booktabs = TRUE)
```
```{r average-kW}
ggplot(ICES_VE, aes(x = avg_kw))+
  geom_histogram() +
  xlab("Average kW") + ylab ("Count") +
  facet_wrap( ~ year, ncol = 2) +
  theme_icesqc()
```

\newpage

## Average kW-hours:
```{r table-kw-fishing-hours, results='asis'}
ICES_VE %>% 
  dplyr::select(year, kw_fishinghours) %>% 
  dplyr::group_by(year) %>% 
  dplyr::summarise_all(dplyr::funs(min, q25, median, mean, q75, max)) %>% 
  kable(booktabs = TRUE)
```
```{r kw-fishing-hours}
ggplot(ICES_VE, aes(x = kw_fishinghours))+
  geom_histogram() +
  xlab("Average kW-hours") + ylab("Count") +
  facet_wrap(~ year, ncol = 2) +
  theme_icesqc()
```

\newpage

## Landings by gear by year:
```{r landings-by-gear-year}
ps <- gear_splits(ICES_VE$totweight, data = ICES_VE, "kg landed", year_groups = 2, gear_groups = 4, func = sum)
ps$table
for (p in ps$plots) print(p)
```

```{r}
d <- 
  ICES_VE %>% 
  dplyr::group_by(year, gear_code) %>% 
  dplyr::summarise(totweight = sum(totweight, na.rm = TRUE)) 
d %>% 
  tidyr::spread(year, totweight) %>% 
  kable(booktab = TRUE)
d %>% 
  ggplot(aes(year, totweight)) +
  theme_icesqc() +
  geom_line() +
  facet_grid(gear_code ~ ., scale = "free_y") +
  expand_limits(y = 0) +
  scale_x_continuous(breaks = c(2000:2030)) +
  labs(x = "Year", y = "kg landed")
```


\newpage

## Spatial distribution of effort by year:
```{r spatial-effort-year, results='asis', fig.height = 9}
d <-
  ICES_VE %>% 
  dplyr::group_by(year, long = SI_LONG, lat = SI_LATI) %>% 
  dplyr::summarise(fishing_days = sum(fishing_hours, na.rm = TRUE)/24)

# legend calculations
breaks <- unique(c(-1, 0, steps * c(1, 2.5, 5, 10, 25, 50, 100, 250)))
legval <- paste(breaks[-length(breaks)], "<=", breaks[-1L])
legval[1] <- "0"

palette <- c("white", RColorBrewer::brewer.pal(length(breaks)-2, "YlOrRd"))  
d$colgrp <- as.numeric(cut(d$fishing_days, breaks = breaks))
d$cols <- palette[d$colgrp]

d %>% 
    ggplot(aes(long, lat)) +
    theme_void() +
    geom_raster(aes(fill = cols)) +
    geom_polygon(data = m.core, aes(group = group), fill = "grey") +
    coord_quickmap(xlim = spatCore$xrange, ylim = spatCore$yrange) +
    scale_fill_manual(values = rev(palette), labels = rev(legval)) +
    guides(fill = guide_legend(title = paste("Days@Sea", topgear[i]))) +
    facet_wrap(~ year, ncol = 2) +
    theme(legend.position = "top")
```

\newpage

## Spatial difference of effort `r tempBound[1]`:`r (tempBound[2]-1)` vs `r tempBound[2]`

```{r spatial-effort--difference1, results='asis', fig.height = 9}
d <- 
  ICES_VE %>% 
  dplyr::select(long = SI_LONG, lat = SI_LATI) %>% 
  dplyr::distinct() %>% 
  dplyr::left_join(ICES_VE %>% 
                     dplyr::filter(year %in% tempBound[2]) %>% 
                     dplyr::group_by(long = SI_LONG, lat = SI_LATI) %>% 
                     dplyr::summarise(fishing_hours = sum(fishing_hours, na.rm = TRUE))) %>% 
  dplyr::left_join(ICES_VE %>% 
                     dplyr::filter(year < tempBound[2]) %>% 
                     dplyr::group_by(year, long = SI_LONG, lat = SI_LATI) %>% 
                     dplyr::summarise(fishing_hours = sum(fishing_hours, na.rm = TRUE)) %>% 
                     dplyr::group_by(long, lat) %>% 
                     dplyr::summarise(fishing_hours_median = median(fishing_hours, na.rm = TRUE))) %>% 
  dplyr::mutate(fishing_hours = ifelse(is.na(fishing_hours), 0, fishing_hours),
                fishing_hours_median = ifelse(is.na(fishing_hours_median), 0, fishing_hours_median),
                # calculate ratio (with exceptions for zeros)
                ratio = 1/(pmax(fishing_hours, 1e-9) / pmax(fishing_hours_median, 1e-9)))

breaks <- c(-Inf, 1/2, 1/1.5, 1/1.25, 1/1.05, 1, 1.05, 1.25, 1.5, 2, Inf)
legval <- c("historic >>","historic> +100%","historic> +50%","historic> +25%",
            "+/-5%",
            "recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
palette <- RColorBrewer::brewer.pal(length(breaks)-1,"RdYlBu")  #colour for fishing intensity
d$colgrp <- as.numeric(cut(d$ratio, breaks = breaks))
d$cols <- palette[d$colgrp]

d %>% 
    ggplot(aes(long, lat)) +
    theme_void() +
    geom_raster(aes(fill = cols)) +
    geom_polygon(data = m.core, aes(group = group), fill = "grey") +
    coord_quickmap(xlim = spatCore$xrange, ylim = spatCore$yrange) +
    scale_fill_manual(values = rev(palette), labels = rev(legval)) +
    labs(x = NULL, y = NULL, fill = "Days@Sea")
```


\newpage

## Spatial difference of effort `r tempBound[2]-1` vs `r tempBound[2]`

```{r spatial-effort--difference2, results='asis', fig.height = 9}
d <- 
  ICES_VE %>% 
  dplyr::filter(year >= (tempBound[2]-1)) %>% 
  dplyr::select(long = SI_LONG, lat = SI_LATI) %>% 
  dplyr::distinct() %>% 
  dplyr::left_join(ICES_VE %>% 
                     dplyr::filter(year %in% tempBound[2]) %>% 
                     dplyr::group_by(long = SI_LONG, lat = SI_LATI) %>% 
                     dplyr::summarise(fishing_hours = sum(fishing_hours, na.rm = TRUE))) %>% 
  dplyr::left_join(ICES_VE %>% 
                     dplyr::filter(year %in% (tempBound[2]-1)) %>% 
                     dplyr::group_by(year, long = SI_LONG, lat = SI_LATI) %>% 
                     dplyr::summarise(fishing_hours = sum(fishing_hours, na.rm = TRUE)) %>% 
                     dplyr::group_by(long, lat) %>% 
                     dplyr::summarise(fishing_hours_median = median(fishing_hours, na.rm = TRUE))) %>% 
  dplyr::mutate(fishing_hours = ifelse(is.na(fishing_hours), 0, fishing_hours),
                fishing_hours_median = ifelse(is.na(fishing_hours_median), 0, fishing_hours_median),
                # calculate ratio (with exceptions for zeros)
                ratio = 1/(pmax(fishing_hours, 1e-9) / pmax(fishing_hours_median, 1e-9)))

breaks <- c(-Inf, 1/2, 1/1.5, 1/1.25, 1/1.05, 1, 1.05, 1.25, 1.5, 2, Inf)
legval <- c("historic >>","historic> +100%","historic> +50%","historic> +25%",
            "+/-5%",
            "recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
palette <- RColorBrewer::brewer.pal(length(breaks)-1,"RdYlBu")  #colour for fishing intensity
d$colgrp <- as.numeric(cut(d$ratio, breaks = breaks))
d$cols <- palette[d$colgrp]

d %>% 
    ggplot(aes(long, lat)) +
    theme_void() +
    geom_raster(aes(fill = cols)) +
    geom_polygon(data = m.core, aes(group = group), fill = "grey") +
    coord_quickmap(xlim = spatCore$xrange, ylim = spatCore$yrange) +
    scale_fill_manual(values = rev(palette), labels = rev(legval)) +
    labs(x = NULL, y = NULL, fill = "Days@Sea")
```

\newpage

## Mean landing per kW fishing hours by year:

```{r landings-by-gear}
ps <- gear_splits(with(ICES_VE, totweight/kw_fishinghours), data = ICES_VE, "kg/kWh", gear_groups = 4, func = median)
ps$table
for (p in ps$plots) print(p)
```

```{r}
d <-
  ICES_VE %>% 
  dplyr::group_by(year, gear_code) %>% 
  dplyr::summarise(value = median(totweight/kw_fishinghours, na.rm = TRUE))
d %>% 
  tidyr::spread(year, value) %>% 
  kable(booktab = TRUE)
d %>% 
  ggplot(aes(year, value)) +
  theme_icesqc() +
  geom_line() +
  facet_grid(gear_code ~ ., scale = "free_y") +
  expand_limits(y = 0) +
  scale_x_continuous(breaks = c(2000:2030)) +
  labs(x = "Year", y = "kg/kWh")
```


\newpage

## Value by gear by year:
```{r value-by-gear-year, results='asis'}
ps <- gear_splits(ICES_VE$totvalue, data = ICES_VE, "EUR landed", gear_groups = 4, func = sum)
ps$table
for (p in ps$plots) print(p)
```

```{r}
d <-
  ICES_VE %>% 
  dplyr::group_by(year, gear_code) %>% 
  dplyr::summarise(value = mean(totvalue, na.rm = TRUE))
d %>% 
  tidyr::spread(year, value) %>% 
  kable(booktab = TRUE)
d %>% 
  ggplot(aes(year, value)) +
  theme_icesqc() +
  geom_line() +
  facet_grid(gear_code ~ ., scale = "free_y") +
  expand_limits(y = 0) +
  scale_x_continuous(breaks = c(2000:2030)) +
  labs(x = "Year", y = "EUR landed")
```

\newpage

## Median value per KW fishing hours by year:

```{r mean-value-by-KWhours-year, results='asis'}
ps <- gear_splits(with(ICES_VE, totvalue/kw_fishinghours), data = ICES_VE, "EUR/kWh", gear_groups = 4, func = median)
ps$table
for (p in ps$plots) print(p)
```

```{r}
d <-
  ICES_VE %>% 
  dplyr::group_by(year, gear_code) %>% 
  dplyr::summarise(value = median(totvalue/kw_fishinghours, na.rm = TRUE))
d %>% 
  tidyr::spread(year, value) %>% 
  kable(booktab = TRUE)
d %>% 
  ggplot(aes(year, value)) +
  theme_icesqc() +
  geom_line() +
  facet_grid(gear_code ~ ., scale = "free_y") +
  expand_limits(y = 0) +
  scale_x_continuous(breaks = c(2000:2030)) +
  labs(x = "Year", y = "EUR landed")
```


\newpage

##  Average price:

```{r price, results='asis'}
ps <- gear_splits(with(ICES_VE, totvalue/totweight), data = ICES_VE, "Mean price (EUR/kg)", gear_groups = 4, func = median)
ps$table
for (p in ps$plots) print(p)
```

```{r}
d <-
  ICES_VE %>% 
  dplyr::group_by(year, gear_code) %>% 
  dplyr::summarise(value = median(totvalue/totweight, na.rm = TRUE))
d %>% 
  tidyr::spread(year, value) %>% 
  kable(booktab = TRUE)
d %>% 
  ggplot(aes(year, value)) +
  theme_icesqc() +
  geom_line() +
  facet_grid(gear_code ~ ., scale = "free_y") +
  expand_limits(y = 0) +
  scale_x_continuous(breaks = c(2000:2030)) +
  labs(x = "Year", y = "Mean price (EUR/kg)")
```





`r if (!hasvms) {"\\end{comment}"}`

\newpage















<!--- 
                       --------------
                       LOGBOOK CHECKS
                       --------------
--->


# Quality of the logbook

`r if (!haslogbook) {"No Logbook data available\n\\begin{comment}"}`

```{r set-eval-logbook}
opts_chunk$set(eval = haslogbook)
```


## Years & number of records for which data has been submitted:
```{r logbook-records, results='asis'}
kable(count(ICES_LE,'year'), booktabs = TRUE)

dat2plot <- data.frame(table(ICES_LE$year))
colnames(dat2plot) <- c("Year","Freq")
ggplot(dat2plot,aes(x=Year,y=Freq)) +
  geom_bar(stat="identity") + xlab("Year") + ylab("Number of records") +
  theme_icesqc()
```

`r if (any(is.na(ICES_LE$SI_LONG))) {"\\newpage"}`

## Records assigned to invalid Statistical Rectangles
```{r invalid stat-sqrs-le}
if (any(is.na(ICES_LE$SI_LONG))) {
  kable(table(`ICES Rectangle` = ICES_LE$ICES_rectangle[is.na(ICES_LE$SI_LONG)],
              Year = ICES_LE$year[is.na(ICES_LE$SI_LONG)]), booktabs = TRUE)
} else {
  x <- "There were no invalid Statistical Rectangles reported"
  attr(x, "format") <- "markdown"
  attr(x, "class") <- "knit_asis"
  x
}
```

\newpage

## Distribution of logbook entries by month:
```{r logbook-entries-month, results='asis'}
kable(table(ICES_LE$month, ICES_LE$year), booktabs = TRUE)

qplot(factor(year),data=ICES_LE, geom="bar",fill=factor(month)) +
  xlab("Years") + ylab ("Count") + scale_fill_grey(guide=guide_legend(title="Month")) +
  theme_icesqc(legend.position = "right")
```

\newpage

## Area extent of data submitted by year:
```{r , results='asis', fig.height = 9}
dat2tab <- as.matrix(aggregate(ICES_LE$SI_LONG, by = list(year = ICES_LE$year), FUN=range, na.rm=TRUE))
dat2tab <- cbind(dat2tab,as.matrix(aggregate(ICES_LE$SI_LATI,by=list(ICES_LE$year), FUN=range, na.rm=TRUE)[,-1]))
colnames(dat2tab) <- c("Year","min lon","max lon","min lat","max lat")
kable(dat2tab, booktabs = TRUE)
```

## Area for which data has been submitted:
```{r , results='asis',fig.height = 9}
coordGrd <- unique(ICES_LE[,c("SI_LONG","SI_LATI","year")])
data_coverage(coordGrd, spatBoundLog, res = 1)
```


```{r , results='asis',fig.height = 9}
data_coverage(coordGrd, spatCore, res = 1)
```

\newpage

## Frequency of vessel length categories by year:
```{r , results='asis'}
kable(table(ICES_LE$vessel_length_category,ICES_LE$year), booktabs = TRUE)

qplot(factor(year), data = ICES_LE, geom = "bar", fill = factor(vessel_length_category)) +
  xlab("Years") + ylab ("Count") + 
  scale_fill_grey(guide = guide_legend(title = "Length category")) +
  theme_icesqc()
```

\newpage

## Frequency of gear codes by year:
```{r , results='asis'}
kable(table(ICES_LE$gear_code,ICES_LE$year), booktabs = TRUE)

qplot(factor(year), data = ICES_LE, geom = "bar", fill = factor(gear_code)) +
  xlab("Years") + ylab("Count") + 
  scale_fill_grey(guide = guide_legend(title = "Gear code")) +
  theme_icesqc(legend.position = "right")
```

\newpage

## Number of unique DCF Level 6 codes by year:
```{r , results='asis'}
kable(count(unique(ICES_LE[,c("LE_MET_level6","year")]),"year"), booktabs = TRUE)
```

## Top 5 DCF Level 6 codes by year:
```{r , results='asis'}
top5Met6 <- names(rev(sort(table(ICES_LE$LE_MET_level6)))[1:5])
kable(table(ICES_LE$LE_MET_level6,ICES_LE$year)[top5Met6,], booktabs = TRUE)

qplot(factor(year), data = subset(ICES_LE,LE_MET_level6 %in% top5Met6),
      geom = "bar", fill = factor(LE_MET_level6)) +
  xlab("Years") + ylab("Count") + 
  scale_fill_grey(guide = guide_legend(title = "Level 6")) +
  theme_icesqc(legend.position = "right")
```

\newpage

## Frequency of VMS enabled category
```{r , results='asis'}
kable(table(ICES_LE$vms_enabled,ICES_LE$vessel_length_category), booktabs = TRUE)
```

## Average fishing days:
```{r , results='asis'}
ggplot(ICES_LE, aes(x = fishing_days))+
  geom_histogram() +
  xlab("Average fishing days") + ylab("Count") +
  facet_wrap(~ year, ncol = 2) +
  theme_icesqc()
```

\newpage

## Average KW-hours:
```{r , results='asis'}
ggplot(ICES_LE, aes(x = kw_fishing_days)) +
  geom_histogram() +
  xlab("Average KW-days") + ylab("Count") +
  facet_wrap(~ year, ncol = 2) +
  theme_icesqc()
```

\newpage

## Landings by gear by year:
```{r , results='asis'}
ps <- gear_splits(ICES_LE$totweight, data = ICES_LE, "kg landed", gear_groups = 4, func = sum)
ps$table
for (p in ps$plots) print(p)
```

\newpage

## Spatial distribution of effort by year:
```{r , results='asis', fig.height = 9}
coordGrd        <- unique(ICES_LE[,c("SI_LONG","SI_LATI","year","ICES_rectangle")])

polRect  <- make_polVMS(coordGrd, resolution = 1)
polRect$year    <- rep(coordGrd$year,each=5)
polRect$ICES_rectangle <- rep(coordGrd$ICES_rectangle, each = 5)

#TIDY ---
dat             <- aggregate(ICES_LE$fishing_days,by=list(ICES_LE$year,ICES_LE$ICES_rectangle),FUN=sum,na.rm=T)

steps               <- ceiling(max(dat$x,na.rm=T)/250)
cutbreaksval        <- unique(c(-1,0,steps*c(1,2.5,5,10,25,50,100,250)))
legval              <- outer(ac(cutbreaksval),ac(cutbreaksval),function(x,y){return(paste(x,"<=",y))})
legval              <- c("0",diag(legval[-1,-c(1,2)]))
palette <- c("white", brewer.pal(length(cutbreaksval)-2,"YlOrRd"))
cols <- palette[cut(dat$x,breaks=cutbreaksval)]
cols                <- cbind(cols,id=1:length(cols),ICES_rectangle=dat$Group.2,year=dat$Group.1)
polRect              <- merge(polRect,cols,by=c("ICES_rectangle","year"))
# ----

spatialplot(polRect) +
  guides(fill = guide_legend(title = "Days@Sea")) +
  scale_fill_manual(values = rev(palette), labels = rev(legval)) +
  facet_wrap(~ year, ncol = 2) +
  theme_icesqc(legend.position = "top")
```

\newpage

## Spatial difference of effort `r tempBound[1]`:`r (tempBound[2]-1)` vs `r tempBound[2]`
```{r,  fig.height = 9}
base <- with(ICES_LE, 
             aggregate(fishing_days, 
                       by = list(ICES_rectangle = ICES_rectangle, year = year),
                       FUN = sum, na.rm = TRUE))
base <- dplyr::rename(base, fishing_days = x)

# calculate total fishing hours for recent year
recent <- base[base$year == tempBound[2],]

# calculate median of the total fishing hours per square for historical years
base <- with(base[base$year < tempBound[2],], 
             aggregate(fishing_days,
                       by = list(ICES_rectangle = ICES_rectangle), 
                       FUN = median, na.rm = TRUE))
base <- dplyr::rename(base, fishing_days_median = x)

# join
dat2plot <- dplyr::full_join(base,
                             recent[,c("ICES_rectangle","fishing_days")])

# set NAs to zero
dat2plot$fishing_days_median[is.na(dat2plot$fishing_days_median)] <- 0
dat2plot$fishing_days[is.na(dat2plot$fishing_days)] <- 0

# calculate ratio (with exceptions for zeros)
dat2plot$ratio <- 1/with(dat2plot, pmax(fishing_days, 1e-9) / pmax(fishing_days_median, 1e-9))

# add back in lat and long
dat2plot <- cbind(dat2plot,
                  vmstools::ICESrectangle2LonLat(dat2plot$ICES_rectangle, midpoint = TRUE))

# make 'fortified' data frame
polRect <- make_polVMS(dat2plot, resolution = 1)
polRect$ICES_rectangle <- rep(dat2plot$ICES_rectangle, each = 5)

## tidy ---
breaks <- rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10))
legval <- c("historic >>","historic> +100%","historic> +50%","historic> +25%",
            "+/-5%",
            "recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
palette <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")
colgrp <- as.numeric(cut(dat2plot$ratio, breaks = breaks))
cols <- cbind(cols = palette[colgrp], ICES_rectangle = dat2plot$ICES_rectangle)
polRect <- merge(polRect, cols, by=c("ICES_rectangle"))
# ---

spatialplot(polRect) +
    guides(fill=guide_legend(title="Days@Sea")) +
    scale_fill_manual(values = rev(palette), labels = legval) +
    theme_icesqc(legend.position = "right")
```

\newpage

## Spatial difference of effort `r tempBound[2]-1` vs `r tempBound[2]`

```{r,  fig.height = 9}
base <- with(ICES_LE, 
             aggregate(fishing_days, 
                       by = list(ICES_rectangle = ICES_rectangle, year = year),
                       FUN = sum, na.rm = TRUE))
base <- dplyr::rename(base, fishing_days = x)

# calculate total fishing hours for recent year
recent <- base[base$year == tempBound[2],]

# previous year
base <- base[base$year == tempBound[2]-1,]
base <- dplyr::rename(base, fishing_days_median = fishing_days)

# join
dat2plot <- dplyr::full_join(base,
                             recent[,c("ICES_rectangle","fishing_days")])

# set NAs to zero
dat2plot$fishing_days_median[is.na(dat2plot$fishing_days_median)] <- 0
dat2plot$fishing_days[is.na(dat2plot$fishing_days)] <- 0

# calculate ratio (with exceptions for zeros)
dat2plot$ratio <- 1/with(dat2plot, pmax(fishing_days, 1e-9) / pmax(fishing_days_median, 1e-9))

# add back in lat and long
dat2plot <- cbind(dat2plot,
                  vmstools::ICESrectangle2LonLat(dat2plot$ICES_rectangle, midpoint = TRUE))

# make 'fortified' data frame
polRect <- make_polVMS(dat2plot, resolution = 1)
polRect$ICES_rectangle <- rep(dat2plot$ICES_rectangle, each = 5)

## tidy ---
breaks <- rev(c(1e-10,0.5,2/3,0.8,0.952381,1,1.05,1.25,1.5,2,1e10))
legval <- c("historic >>","historic> +100%","historic> +50%","historic> +25%",
            "+/-5%",
            "recent> +5%","recent> +25%","recent> +50%","recent> +100%","recent >>")
palette <- brewer.pal(length(cutbreaksval)-1,"RdYlBu")
colgrp <- as.numeric(cut(dat2plot$ratio, breaks = breaks))
cols <- cbind(cols = palette[colgrp], ICES_rectangle = dat2plot$ICES_rectangle)
polRect <- merge(polRect, cols, by=c("ICES_rectangle"))
# ---

spatialplot(polRect) +
    guides(fill=guide_legend(title="Days@Sea")) +
    scale_fill_manual(values = rev(palette), labels = legval) +
    theme_icesqc(legend.position = "right")
```

\newpage


## Relationship fishing days and total weight
```{r , fig.height = 9}
ggplot(ICES_LE[ICES_LE$year == tempBoundLog[2],], 
       aes(x = fishing_days, y = totweight)) +
  geom_point() +
  facet_wrap(~ gear_code, ncol = 3, scale = "free") +
  xlab("Fishing days") + ylab ("Total weight") +
  theme_icesqc()
```

\newpage

## Mean landing per KW fishing day by year:

```{r , results='asis'}
ps <- gear_splits(with(ICES_LE, totweight/kw_fishing_days), data = ICES_LE, "kg landed", gear_groups = 4, func = median)
ps$table
for (p in ps$plots) print(p)
```

\newpage

## Value by gear by year:
```{r , results='asis'}
ps <- gear_splits(with(ICES_LE, totvalue), data = ICES_LE, "EUR landed", gear_groups = 4, func = median)
ps$table
for (p in ps$plots) print(p)
```

\newpage

## Mean value per KW fishing day by year:

```{r , results='asis'}
ps <- gear_splits(with(ICES_LE, totvalue/kw_fishing_days), data = ICES_LE, "EUR/kWh", gear_groups = 4, func = median)
ps$table
for (p in ps$plots) print(p)
```

\newpage

##  Average price:

```{r , results='asis'}
ps <- gear_splits(with(ICES_LE, totvalue/totweight), data = ICES_LE, "Mean price (EUR/kg)", gear_groups = 4, func = median)
cat(ps$table)
for (p in ps$plots) print(p)
```

\newpage

## Comparison of Metier level 6 reporting between logbook and VMS
```{r met6-comparison, results = 'asis'}

ledat <- with(ICES_LE, table(LE_MET_level6, year))
vedat <- with(ICES_VE, table(LE_MET_level6, year))

dat2tab <- 
  rbind(
    cbind(as.data.frame.table(ledat), data = "LE (records)"),
    cbind(as.data.frame.table(vedat), data = "VE (pings)"))

tab <- with(dat2tab, tapply(Freq, list(LE_MET_level6, data, year), sum))
tab[tab == 0] <- NA

for (i in dimnames(tab)[[3]]) {
  x <- tab[,,i]
  x <- x[apply(!is.na(x), 1, any),]
  cat(kable(cbind(x, year = i), booktabs = TRUE), sep = "\n")
  cat("\n")
}
```

`r if (!haslogbook) {"\\end{comment}"}`
